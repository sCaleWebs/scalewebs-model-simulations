---
title: "Beta diversity and species responses"
description: |
  A short description of the post.
author:
  - name: Andrew MacDonald
    url: https://example.com/norajones
date: 04-13-2022
output:
  distill::distill_article:
    self_contained: false
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
```

### Food web simulations

Need to simulate the food web in a plausible way. Some constraints:

1. All species except basal resources need a link
2. most species will have only 3 connections (ie they eat basal resources)

finally, we want to relate a species number of links to the community. 

Number of links per consumer is :

$$
L_i = (S - 1)p_i + 1
$$

possibly with the constraint that the one link can't be a cannibal! 

The probability of a link, $p_i$ is another way of thinking about the degree of a species

In our dataset the modal species richness is *3* because most species are detritivores that eat all the basal resources   

<aside>
Do we want to have some kind of.. *3*-inflated distribution for our links? 
</aside>

One simple way to do this is to allow the node distribution to have an average centered on 3 

The steps:
* find the average p for a food web where most species eat 3 things
* let each consumer have a different p (complexify this later)
* draw links for each predator

```{r}
n_basal <- 3
S <- 12

mean_p <- (n_basal - 1)/(S - 1)

consumer_probs <- rbeta(n = S - n_basal, mean_p * 3, (1 - mean_p) * 3)

consumer_links <- rbinom(S - n_basal, S - 1, prob = consumer_probs) + 1

hist(consumer_links)
```


this could be converted to the logit scale: 

```{r}
consumer_probs_logit <- plogis(qlogis(mean_p) + rnorm(S - n_basal, mean = 0, sd = .2))

degrees <- rbinom(S - n_basal, S - 1, prob = consumer_probs_logit) + 1

tibble(degrees) |> 
  count(degrees) |> 
  ggplot(aes(x = degrees, y = n)) + 
  geom_bar(stat = "identity") + 
  coord_cartesian(xlim = c(0, S))
```


### simulate incidence functions

$$
\begin{align}
Y_i &\sim \text{Binomial}(p, 1) \\
\text{logit}(p) &= a(\phi - b) \\
\phi &= \bar{\phi} + \beta_{e}X_e \\
\begin{bmatrix} a \cr b\ \end{bmatrix} &\sim \text{MVN}(\begin{bmatrix} \bar{a} \cr \bar{b}\ \end{bmatrix}, \Sigma)
\end{align}
$$

```{r}
nsites <- 45
x <- runif(nsites, min = -3, max = 3)

bar_phi <- -1
beta_phi <- .3

phi <- bar_phi + beta_phi * x

plot(x, plogis(phi))
```

simulate correlated $a$ and $b$

```{r}
corr_mat <- matrix(c(1, .5, .5, 1), nrow = 2)
sds <- c(.4, 1)

sig <- diag(sds) %*% corr_mat %*% diag(sds)

consumer_a_b <- MASS::mvrnorm(S - n_basal, mu = c(1.5, -3), Sigma = sig)
```

match species and sites to the coefs:

```{r}
fake_data <- expand_grid(site = 1:nsites, sp = 1:(S - n_basal)) |> 
  mutate(
    x = x[site],
    logit_prob = consumer_a_b[sp, 1] * (phi[site] - consumer_a_b[sp, 2]))

fake_data |> 
  ggplot(aes(x = x, y = logit_prob, group = sp)) + 
  geom_line()



fake_data |> 
  ggplot(aes(x = x, y = plogis(logit_prob), group = sp)) + 
  geom_line()

```

Now, we need to sample species compositions from this curve

```{r}
fake_data_obs <- fake_data |> 
  mutate(prb = plogis(logit_prob),
         presabs = rbinom(nrow(fake_data), size = 1, prob = prb))

fake_data_obs |> 
  group_by(site, x) |> 
  summarize(richness = sum(presabs)) |> 
  ggplot(aes(x = x, y = richness)) + geom_point()
```

Finally, we can tweak the simulation to include correlations between the response to the environment and the number of nodes

Could then look at the relationship between connectance and the environment, for example


